<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>Word Validation Task</title>
<style>
  body { background:black; color:white; font-family:Arial; text-align:center; }
  #stim { font-size:60px; margin-top:200px; }
  #labels { margin-top:100px; font-size:30px; display:flex; justify-content:space-between; width:80%; margin:auto;}
  #instruction { font-size:40px; white-space:pre-line; }
</style>
</head>
<body>

<div id="instruction">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ñ‡∏≥...</div>
<div id="stim"></div>
<div id="labels">
  <div id="leftLabel"></div>
  <div id="rightLabel"></div>
</div>

<script>
let participant = prompt("Participant:");
let filename = participant + "_VAL.csv";

let phase = "instruction";

let social_instruction = `‡∏Å‡∏î SPACE ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ö‡∏•‡πá‡∏≠‡∏Å social`;
let quality_instruction = `‡∏Å‡∏î SPACE ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ö‡∏•‡πá‡∏≠‡∏Å quality`;

let socialTrials = [];
let qualityTrials = [];
let allData = [];

let blockOrder = ["social","quality"];
let blockIndex = 0;
let trialIndex = 0;
let currentTrials = [];
let currentMapping = {};
let currentBlockName = "";
let startTime = 0;

// üî¥ ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå + ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏à‡∏£‡∏¥‡∏á‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
Promise.all([
  fetch("wordlist.json"),
  fetch("wordlist_quality.json")
]).then(async ([r1, r2]) => {
  if(!r1.ok || !r2.ok) throw "‡∏´‡∏≤‡πÑ‡∏ü‡∏•‡πå json ‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠";

  socialTrials = await r1.json();
  qualityTrials = await r2.json();

  startBlock();
}).catch(err => {
  document.getElementById("instruction").innerText =
    "ERROR ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏Ñ‡∏≥‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à\n" + err;
});

// key listener
document.addEventListener("keydown", e => {
  let k = e.key.toLowerCase();

  if (e.code === "Space" && phase === "instruction") {
    phase = "trial";
    showTrial();
  }

  if (phase === "trial" && (k === "a" || k === "l")) {
    respond(k);
  }
});

function startBlock(){
  trialIndex = 0;
  phase = "instruction";

  let blockType = blockOrder[blockIndex];

  if(blockType==="social"){
    showInstruction(social_instruction);
    currentTrials = shuffle([...socialTrials]);
    currentMapping = {"‡∏ä‡∏≠‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏±‡∏á‡∏Ñ‡∏°":"a","‡πÑ‡∏°‡πà‡∏ä‡∏≠‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏±‡∏á‡∏Ñ‡∏°":"l"};
    currentBlockName = "social";
  } else {
    showInstruction(quality_instruction);
    currentTrials = shuffle([...qualityTrials]);
    currentMapping = {"‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û‡∏î‡∏µ":"a","‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û‡∏ï‡πà‡∏≥":"l"};
    currentBlockName = "quality";
  }
}

function showInstruction(text){
  instruction.innerText = text;
  stim.innerText = "";
  leftLabel.innerText = "";
  rightLabel.innerText = "";
}

function showTrial(){
  if(trialIndex >= currentTrials.length){
    blockIndex++;
    if(blockIndex >= blockOrder.length){
      instruction.innerText = "‡∏à‡∏ö‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏•‡∏≠‡∏á";
      return;
    } else {
      startBlock();
    }
    return;
  }

  let t = currentTrials[trialIndex];
  instruction.innerText = "";
  stim.innerText = t.word;

  startTime = performance.now();
}

function respond(key){
  trialIndex++;
  setTimeout(showTrial,500);
}

function shuffle(a){
  return a.sort(()=>Math.random()-0.5);
}

function downloadCSV() {
  let csv = "word,cat,key,rt,corr\n";
  data.forEach(r=>{
    csv += `${r.word},${r.cat},${r.key},${r.rt},${r.corr}\n`;
  });

  let blob = new Blob([csv], {type:"text/csv"});
  let url = URL.createObjectURL(blob);
  let a = document.createElement("a");
  a.href = url;
  a.download = "data.csv";
  a.click();
}

</script>

</body>
</html>