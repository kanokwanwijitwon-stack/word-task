<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>Word Validation Task</title>
<style>
body {
  margin:0;
  background:black;
  color:white;
  font-family:Arial;
  text-align:center;
}
#instruction {
  white-space: pre-line;
  font-size:32px;
  margin-top:200px;
}
#stim {
  font-size:60px;
  margin-top:200px;
}
#labels {
  position:fixed;
  top:50px;
  width:100%;
  display:flex;
  justify-content:space-between;
  padding:0 120px;
  font-size:28px;
}
</style>
</head>
<body>

<div id="instruction"></div>
<div id="stim"></div>
<div id="labels">
  <div id="leftLabel"></div>
  <div id="rightLabel"></div>
</div>

<script>
let participant = prompt("Participant ID:");
let blockOrder = ["social","quality","social","quality","social","quality","social","quality"];
let currentBlock = 0;
let trials = [];
let trialIndex = 0;
let startTime = 0;
let data = [];

const social_instruction = `
ถ้าคำมีความหมายว่า
"ชอบเข้าสังคม" กด A

ถ้า
"ไม่ชอบเข้าสังคม" กด L

กด SPACE เพื่อเริ่ม
`;

const quality_instruction = `
ถ้าคำมีความหมายว่า
"คุณภาพดี" กด A

ถ้า
"คุณภาพต่ำ" กด L

กด SPACE เพื่อเริ่ม
`;

function shuffle(array){
  for(let i=array.length-1;i>0;i--){
    let j=Math.floor(Math.random()*(i+1));
    [array[i],array[j]]=[array[j],array[i]];
  }
}

document.addEventListener("keydown", e=>{
  if(e.code==="Space" && startTime===0){
    startBlock();
  }
  if(e.key==="a" || e.key==="l"){
    respond(e.key);
  }
});

function startBlock(){
  document.getElementById("instruction").innerText="";
  let block = blockOrder[currentBlock];
  let file = block==="social" ? "wordlist_social.json" : "wordlist_quality.json";

  fetch(file)
    .then(r=>r.json())
    .then(json=>{
      trials = json;
      shuffle(trials);
      trialIndex = 0;
      showTrial();
    });
}

function showInstruction(){
  let block = blockOrder[currentBlock];
  document.getElementById("stim").innerText="";
  document.getElementById("leftLabel").innerText="";
  document.getElementById("rightLabel").innerText="";
  document.getElementById("instruction").innerText =
    block==="social" ? social_instruction : quality_instruction;
  startTime = 0;
}

function showTrial(){
  if(trialIndex>=trials.length){
    currentBlock++;
    if(currentBlock>=blockOrder.length){
      finish();
      return;
    }
    showInstruction();
    return;
  }

  let t = trials[trialIndex];
  document.getElementById("stim").innerText = t.word;

  if(blockOrder[currentBlock]==="social"){
    document.getElementById("leftLabel").innerText="ชอบเข้าสังคม";
    document.getElementById("rightLabel").innerText="ไม่ชอบเข้าสังคม";
  } else {
    document.getElementById("leftLabel").innerText="คุณภาพดี";
    document.getElementById("rightLabel").innerText="คุณภาพต่ำ";
  }

  startTime = performance.now();
}

function respond(key){
  if(!startTime) return;

  let rt = performance.now() - startTime;
  let t = trials[trialIndex];
  let corrKey = t.cat==="A" ? "a" : "l";
  let corr = key===corrKey ? 1 : 0;

  data.push({
    participant: participant,
    block: blockOrder[currentBlock],
    word: t.word,
    cat: t.cat,
    key: key,
    rt: rt.toFixed(1),
    corr: corr
  });

  trialIndex++;
  startTime=0;
  setTimeout(showTrial,500); // ITI 0.5s
}

function finish(){
  document.getElementById("stim").innerText="จบการทดลอง";
  let csv="participant,block,word,cat,key,rt,corr\n";
  data.forEach(r=>{
    csv+=`${r.participant},${r.block},${r.word},${r.cat},${r.key},${r.rt},${r.corr}\n`;
  });

  let blob=new Blob([csv],{type:"text/csv"});
  let url=URL.createObjectURL(blob);
  let a=document.createElement("a");
  a.href=url;
  a.download=participant+"_VAL.csv";
  a.click();
}

showInstruction();
</script>
</body>
</html>