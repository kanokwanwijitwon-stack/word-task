<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>Word Validation Task</title>
<style>
  body { background:black; color:white; font-family:Arial; text-align:center; }
  #stim { font-size:60px; margin-top:200px; }
  #labels { margin-top:100px; font-size:30px; display:flex; justify-content:space-between; width:80%; margin:auto;}
  #instruction { font-size:40px; white-space:pre-line; }
</style>
</head>
<body>

<div id="instruction"></div>
<div id="stim"></div>
<div id="labels">
  <div id="leftLabel"></div>
  <div id="rightLabel"></div>
</div>

<script>
let participant = prompt("Participant:");
let filename = participant + "_VAL.csv";

let phase = "instruction";

let social_instruction = `
ในบล็อกนี้ คุณจะเห็นคำปรากฏบนหน้าจอ

ถ้าคำมีความหมายว่า
'ชอบเข้าสังคม'
ให้กดปุ่ม A

ถ้าคำมีความหมายว่า
'ไม่ชอบเข้าสังคม'
ให้กดปุ่ม L

กรุณาตอบให้เร็วและแม่นยำที่สุด

กดปุ่ม SPACE เพื่อเริ่ม
`;

let quality_instruction = `
ในบล็อกนี้ คุณจะเห็นคำปรากฏบนหน้าจอ

ถ้าคำมีความหมายว่า
'คุณภาพดี'
ให้กดปุ่ม A

ถ้าคำมีความหมายว่า
'คุณภาพต่ำ'
ให้กดปุ่ม L

กรุณาตอบให้เร็วและแม่นยำที่สุด

กดปุ่ม SPACE เพื่อเริ่ม
`;

let socialTrials = [];
let qualityTrials = [];
let allData = [];

let blockOrder = [];
for(let i=0;i<4;i++){
  blockOrder.push("social");
  blockOrder.push("quality");
}

let blockIndex = 0;
let trialIndex = 0;
let currentTrials = [];
let currentMapping = {};
let currentBlockName = "";
let startTime = 0;

// โหลดไฟล์คำ
Promise.all([
  fetch("wordlist.json").then(r => r.json()),
  fetch("wordlist_quality.json").then(r => r.json())
]).then(([social, quality]) => {
  socialTrials = social;
  qualityTrials = quality;

}).catch(err => {
  alert("โหลดไฟล์คำไม่สำเร็จ: " + err);
});

// ฟังค์ชันสุ่ม
function shuffle(array){
  return array.sort(()=>Math.random()-0.5);
}

// key listener
document.addEventListener("keydown", e => {
  let k = e.key.toLowerCase();

  if (e.code === "Space" && phase === "instruction") {
    phase = "trial";
    showTrial();
  }

  if (phase === "trial" && (k === "a" || k === "l")) {
    respond(k);
  }
});

// เริ่ม block
function startBlock(){
  trialIndex = 0;
  phase = "instruction";

  let blockType = blockOrder[blockIndex];

  if(blockType==="social"){
    showInstruction(social_instruction);
    currentTrials = shuffle([...socialTrials]);
    currentMapping = {"ชอบเข้าสังคม":"a","ไม่ชอบเข้าสังคม":"l"};
    currentBlockName = "Block2_sociability";
  } else {
    showInstruction(quality_instruction);
    currentTrials = shuffle([...qualityTrials]);
    currentMapping = {"คุณภาพดี":"a","คุณภาพต่ำ":"l"};
    currentBlockName = "Block2_quality";
  }
}

// แสดง instruction
function showInstruction(text){
  document.getElementById("instruction").innerText = text;
  document.getElementById("stim").innerText = "";
  document.getElementById("leftLabel").innerText = "";
  document.getElementById("rightLabel").innerText = "";
  phase = "instruction";
}

// แสดง trial
function showTrial(){
  if(trialIndex >= currentTrials.length){
    blockIndex++;
    if(blockIndex >= blockOrder.length){
      downloadCSV();
    } else {
      startBlock();
    }
    return;
  }

  let t = currentTrials[trialIndex];
  document.getElementById("instruction").innerText = "";
  document.getElementById("stim").innerText = t.word;

  if(currentBlockName==="Block2_sociability"){
    document.getElementById("leftLabel").innerText = "ชอบเข้าสังคม";
    document.getElementById("rightLabel").innerText = "ไม่ชอบเข้าสังคม";
  } else {
    document.getElementById("leftLabel").innerText = "คุณภาพดี";
    document.getElementById("rightLabel").innerText = "คุณภาพต่ำ";
  }

  startTime = performance.now();
}

// ตอบสนอง
function respond(key){
  let rt = performance.now() - startTime;
  let t = currentTrials[trialIndex];
  let corrKey = currentMapping[t.cat];
  let corr = key===corrKey ? 1 : 0;

  allData.push({
    block: currentBlockName,
    stim: t.word,
    cat: t.cat,
    key: key,
    rt: rt.toFixed(1),
    corr: corr
  });

  trialIndex++;

  document.getElementById("stim").innerText = "";
  document.getElementById("leftLabel").innerText = "";
  document.getElementById("rightLabel").innerText = "";

  // ITI 0.5 sec
  setTimeout(showTrial,500);
}

// save CSV
function downloadCSV(){
  let csv = "participant,block,stim,cat,key,rt,corr\n";
  allData.forEach(r=>{
    csv += `${participant},${r.block},${r.stim},${r.cat},${r.key},${r.rt},${r.corr}\n`;
  });

  let blob = new Blob([csv],{type:"text/csv"});
  let url = URL.createObjectURL(blob);
  let a = document.createElement("a");
  a.href=url;
  a.download=filename;
  a.click();
}

// เริ่ม block แรก
startBlock();
</script>

</body>
</html>