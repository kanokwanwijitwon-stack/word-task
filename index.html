<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>Word Validation Task</title>
<style>
  body { background:black; color:white; font-family:Arial; text-align:center; }
  #stim { font-size:60px; margin-top:200px; }
  #labels { margin-top:100px; font-size:30px; display:flex; justify-content:space-between; width:80%; margin:auto;}
  #instruction { font-size:40px; white-space:pre-line; }
</style>
</head>
<body>

<div id="instruction">กำลังโหลดคำ...</div>
<div id="stim"></div>
<div id="labels">
  <div id="leftLabel"></div>
  <div id="rightLabel"></div>
</div>

<script>
let participant = prompt("Participant:");
let filename = participant + "_VAL.csv";

let social_instruction = `
ในบล็อกนี้ คุณจะเห็นคำปรากฏบนหน้าจอ

ถ้าคำมีความหมายว่า
'ชอบเข้าสังคม' กด A

ถ้า 'ไม่ชอบเข้าสังคม' กด L

กด SPACE เพื่อเริ่ม
`;

let quality_instruction = `
ในบล็อกนี้ คุณจะเห็นคำปรากฏบนหน้าจอ

ถ้าคำมีความหมายว่า
'คุณภาพดี' กด A

ถ้า 'คุณภาพต่ำ' กด L

กด SPACE เพื่อเริ่ม
`;

let socialTrials = [];
let qualityTrials = [];
let allData = [];

let blockOrder = ["social","quality"];
let blockIndex = 0;
let trialIndex = 0;
let currentTrials = [];
let currentMapping = {};
let currentBlock = "";
let phase = "loading";
let startTime = 0;

// ===== LOAD WORD LISTS =====
Promise.all([
  fetch("wordlist.json"),
  fetch("wordlist_quality.json")
]).then(async ([r1, r2]) => {
  socialTrials = await r1.json();
  qualityTrials = await r2.json();
  startBlock();
}).catch(err=>{
  instruction.innerText = "โหลดไฟล์คำไม่สำเร็จ";
});

// ===== KEY LISTENER =====
document.addEventListener("keydown", e=>{
  let k = e.key.toLowerCase();

  if(e.code==="Space" && phase==="instruction"){
    phase="trial";
    showTrial();
  }

  if(phase==="trial" && (k==="a" || k==="l")){
    respond(k);
  }
});

// ===== START BLOCK =====
function startBlock(){
  trialIndex = 0;
  phase = "instruction";

  let type = blockOrder[blockIndex];

  if(type==="social"){
    instruction.innerText = social_instruction;
    currentTrials = shuffle([...socialTrials]);
    currentMapping = {"ชอบเข้าสังคม":"a","ไม่ชอบเข้าสังคม":"l"};
    currentBlock = "social";
  } else {
    instruction.innerText = quality_instruction;
    currentTrials = shuffle([...qualityTrials]);
    currentMapping = {"คุณภาพดี":"a","คุณภาพต่ำ":"l"};
    currentBlock = "quality";
  }

  stim.innerText="";
  leftLabel.innerText="";
  rightLabel.innerText="";
}

// ===== SHOW TRIAL =====
function showTrial(){
  if(trialIndex >= currentTrials.length){
    blockIndex++;
    if(blockIndex >= blockOrder.length){
      instruction.innerText="จบการทดลอง";
      downloadCSV();
      return;
    } else {
      startBlock();
      return;
    }
  }

  let t = currentTrials[trialIndex];
  instruction.innerText="";
  stim.innerText = t.word;

  if(currentBlock==="social"){
    leftLabel.innerText="ชอบเข้าสังคม";
    rightLabel.innerText="ไม่ชอบเข้าสังคม";
  } else {
    leftLabel.innerText="คุณภาพดี";
    rightLabel.innerText="คุณภาพต่ำ";
  }

  startTime = performance.now();
}

// ===== RESPONSE =====
function respond(key){
  let rt = performance.now() - startTime;
  let t = currentTrials[trialIndex];

  let corrKey = currentMapping[t.cat];
  let corr = (key===corrKey)?1:0;

  allData.push({
    participant: participant,
    block: currentBlock,
    word: t.word,
    cat: t.cat,
    key: key,
    rt: rt.toFixed(1),
    corr: corr
  });

  trialIndex++;
  setTimeout(showTrial,500); // ITI 0.5 sec
}

// ===== SHUFFLE =====
function shuffle(a){
  return a.sort(()=>Math.random()-0.5);
}

// ===== SAVE CSV =====
function downloadCSV(){
  let csv="participant,block,word,cat,key,rt,corr\n";
  allData.forEach(r=>{
    csv+=`${r.participant},${r.block},${r.word},${r.cat},${r.key},${r.rt},${r.corr}\n`;
  });

  let blob=new Blob([csv],{type:"text/csv"});
  let url=URL.createObjectURL(blob);
  let a=document.createElement("a");
  a.href=url;
  a.download=filename;
  a.click();
}
</script>

</body>
</html>